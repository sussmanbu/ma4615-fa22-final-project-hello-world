---
title: Model & Prediction
description:
toc: true
featuredVideo:
featuredImage: https://www.kff.org/wp-content/uploads/2018/10/9256-figure-1.png
draft: false
---
## Motivations for modeling

After observing 

## Create training and testing datasets

We first collect all our 2019 datasets and combine them together to create the  trainning dataset called "Train" and combined all our 2020 datasets to create the testing dataset called "Test". Again, we only have 51 observations since we need to merge all out datasets by the common variables "state" and there are only 51 states in the U.S.
```{r echo = FALSE, warning = FALSE,message = FALSE}
library(tidyverse)
Train <- read_csv(here::here("dataset","total.csv"),col_types = cols_only(Medicare_Coverage=col_number(),year=col_number(),LOS=col_number(),state=col_character()))
Train <- Train %>% filter(year==2019)
population_Train <- read_csv(here::here("dataset","population.csv"),col_types = cols_only(state=col_character(),Year2019=col_number()))
hs_Train <- read_csv(here::here("dataset","HS2019.csv"))
GDP_Train <- read_csv(here::here("dataset","GDP2019.csv"))
GPCI_Train <- read_csv(here::here("dataset","GPCI2019.csv"))
GPCI_Train<-GPCI_Train %>% group_by(state) %>% summarise(PW_GPCI=mean(PW_GPCI),PE_GPCI=mean(PE_GPCI),MP_GPCI=mean(MP_GPCI))
HCC_Train <- read_csv(here::here("dataset","HCC.csv"),col_types=cols_only(BENE_AVG_RISK_SCRE=col_number(),ACUTE_HOSP_READMSN_PCT=col_number(),state=col_character(),YEAR=col_number()))
HCC_Train <- na.omit(HCC_Train)
HCC_Train$state<-substr(HCC_Train$state,0,2)
HCC_Train<-HCC_Train %>% filter(YEAR==2019) %>% group_by(state) %>%  summarise(BENE_AVG_RISK_SCRE=mean(BENE_AVG_RISK_SCRE),ACUTE_HOSP_READMSN_PCT=mean(ACUTE_HOSP_READMSN_PCT))
df_list <- list(GPCI_Train,Train,hs_Train,GDP_Train,population_Train,HCC_Train)
Train <- df_list %>% reduce(full_join,by='state')
Train <- Train%>% select(PW_GPCI:Medicare_Coverage,Health_Status,GDP,BENE_AVG_RISK_SCRE,ACUTE_HOSP_READMSN_PCT) %>% head(-3)
# GDP_Test <- read_csv(here::here("dataset","GDP.csv"))
# GPCI_Test <- read_csv(here::here("dataset","GPCI2020.csv"))
# hs_Test <- read_csv(here::here("dataset","HS2020.csv"))
# population_Test <- read_csv(here::here("dataset","population.csv"),col_types = cols_only(state=col_character(),Year2020=col_number()))
# LOS_Test <- read_csv(here::here("dataset","Avg_LOS.csv"))
# Medicare_Test <- read_csv(here::here("dataset","Medicare_data_sum.csv"),col_types = cols_only(state=col_character(),Medicare_Coverage=col_number()))
# df_list2 <- list(GPCI_Test,hs_Test,GDP_Test,population_Test,LOS_Test,Medicare_Test,Hcc_Test)
Test <- read_csv(here::here("dataset","Data_Combined.csv"))
Test <- Test %>% select(BENE_AVG_RISK_SCRE:GDP,Medicare_Coverage:LOS,Health_Status)
```




```{r echo = FALSE, warning = FALSE,message = FALSE}
library(GGally)
ggpairs(Train,upper = list(continuous = wrap("points", alpha = 0.3,size=0.1)),
        lower = list(continuous = wrap('cor', size = 4)))
```

We then create the scatterplot matrix of all the variables, figuring out which variables have the biggest correlation with Medicare_Coverage. According to the graph, Los seems like the one with the highest correlation.

```{r echo = FALSE, warning = FALSE,message = FALSE}
fit1 <- lm(Medicare_Coverage~.,data=Train)
summary(fit1)
```

We first fit a linear regression model on our output Medicare_Coverge with all other x variables, and get an Adjusted R-squared of 0.05534, which is a very low amount
```{r echo = FALSE, warning = FALSE,message = FALSE}
aic<-step(fit1,direction='both')
```

```{r echo = FALSE, warning = FALSE,message = FALSE}
fit2<-lm(Medicare_Coverage ~ LOS + BENE_AVG_RISK_SCRE + ACUTE_HOSP_READMSN_PCT,data=Train)
summary(fit2)
```

```{r echo = FALSE, warning = FALSE,message = FALSE}
sdres1 = rstandard(fit2)
yhat1 = fit2$fitted.values
plot(yhat1, sdres1)
```


```{r echo = FALSE, warning = FALSE,message = FALSE}
qqnorm(sdres1)
qqline(sdres1)
ggplot(data = data.frame(sdres1), aes(x = sdres1)) + geom_histogram(bins = 30) +
  ggtitle("Histogram MLS Plot")
```

```{r echo = FALSE, warning = FALSE,message = FALSE}
#Residual for training data
Resfit <- resid(fit2)
attach(Test)
new_data=data.frame(LOS,BENE_AVG_RISK_SCRE,ACUTE_HOSP_READMSN_PCT)
output<-predict(fit2, se.fit = TRUE, newdata=new_data)
ResfitValidation <- Test$Medicare_Coverage - output$fit
MSE<-mean((ResfitValidation)^2)
RMSE<-mean((ResfitValidation)^2) / mean((Test$Medicare_Coverage)^2)
```

```{r echo = FALSE, warning = FALSE,message = FALSE}
tested = data.frame(Test$Medicare_Coverage,output$fit, 1:length(output$fit));
colnames(tested)[1] = "Medicare_Coverage"
colnames(tested)[2] = "Prediction"
colnames(tested)[3] = "Index"
ggplot(data = tested, aes(x = Medicare_Coverage, y = Prediction)) + geom_point() +
  geom_abline(intercept = 0, slope = 1) +
  ggtitle("Validation Medicare Coverage vs Prediction")
```

```{r echo = FALSE, warning = FALSE,message = FALSE}
ggplot(data = tested, aes(x = Index)) +
  geom_line(aes(y = Medicare_Coverage, color = "Medicare_Coverage")) + 
  geom_line(aes(y = Prediction, color = "Prediction_Medicare_Coverage"), linetype="twodash") +  
  scale_color_manual(name = element_blank(), labels = c("Prediction of Medicare Coverage", "Medicare Coverage"),
                     values = c("darkred", "steelblue")) + labs(y = "") + 
  ggtitle("Linear regression Prediction vs. Validation")
```